Resources:
  {{each endpoints}}
  {{with cloudfront}}
  CloudFront{{../index}}:
    Type: "AWS::CloudFront::Distribution"
    Properties:
      DistributionConfig:
        Aliases:
          - {{hostname}}
        Comment: Static site deployed by Haiku9
        DefaultCacheBehavior:
          AllowedMethods: ["DELETE", "GET", "HEAD", "OPTIONS", "PATCH", "POST", "PUT"]
          CachedMethods: ["GET", "HEAD", "OPTIONS"]
          Compress: true
          MinTTL: 0
          MaxTTL: 31536000
          DefaultTTL: {{expires}}
          ForwardedValues:
            Cookies:
              Forward: "all"
            {{if headers}}
            Headers:
              {{each headers}}
              - "{{.}}"
              {{/each}}
            {{/if}}
            QueryString: true
            QueryStringCacheKeys: ["*"]
          SmoothStreaming: false
          TargetOriginId: HaikuS3Origin
          ViewerProtocolPolicy: {{protocolPolicy}}
        DefaultRootObject: ""
        Enabled: true
        HttpVersion: {{httpVersion}}
        IPV6Enabled: false
        Origins:
          - Id: HaikuS3Origin
            DomainName: {{bucketURL}}
            OriginPath: ""
            S3OriginConfig: {}
        PriceClass: PriceClass_{{priceClass}}
        ViewerCertificate:
          {{if certificate}}
          ACMCertificateArn: {{certificate}}
          SSLSupportMethod: "sni-only"
          MinimumProtocolVersion: {{protocolVersion}}
          {{else}}
          CloudFrontDefaultCertificate: true
          MinimumProtocolVersion: "SSLv3"
          CertificateSource: "cloudfront"
          {{/if}}
  {{/with}}

  {{with route53}}
  DNS{{../index}}:
    Type: AWS::Route53::RecordSetGroup
    DependsOn:
      - CloudFront{{../index}}
    Properties:
      Comment: Media endpoint
      HostedZoneId: {{hostedZoneID}}
      RecordSets:
        - Name: {{record.name}}
          Type: A
          AliasTarget:
            DNSName:
              "Fn::GetAtt":
                - "CloudFront{{../index}}"
                - "DomainName"
            EvaluateTargetHealth: false
            HostedZoneId: Z2FDTNDATAQYW2
  {{/with}}
  {{/each}}
