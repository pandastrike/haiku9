Resources:
  {{#each cloudfront}}
  CloudFront{{@index}}:
    Type: "AWS::CloudFront::Distribution"
    Properties:
      DistributionConfig:
        Aliases:
          - {{hostname}}
        Comment: Static site deployed by Haiku9
        DefaultCacheBehavior:
          AllowedMethods: ["DELETE", "GET", "HEAD", "OPTIONS", "PATCH", "POST", "PUT"]
          CachedMethods: ["GET", "HEAD", "OPTIONS"]
          Compress: false
          MinTTL: 0
          MaxTTL: 31536000
          DefaultTTL: {{expires}}
          ForwardedValues:
            Cookies:
              Forward: "all"
            {{#if headers}}
            Headers:
              {{#each headers}}
              - "{{.}}"
              {{/each}}
            {{/if}}
            QueryString: true
            QueryStringCacheKeys: ["*"]
          SmoothStreaming: false
          TargetOriginId: HaikuS3Origin
          ViewerProtocolPolicy: {{protocolPolicy}}
          {{#if lambdas}}
          LambdaFunctionAssociations:
            {{#each lambdas}}
            - EventType: {{type}}
              LambdaFunctionARN: {{arn}}
            {{/each}}
          {{/if}}
        DefaultRootObject: ""
        Enabled: true
        HttpVersion: {{httpVersion}}
        IPV6Enabled: false
        Origins:
          - Id: HaikuS3Origin
            DomainName: {{bucketURL}}
            OriginPath: ""
            CustomOriginConfig:
              HTTPPort: 80
              OriginProtocolPolicy: "http-only"
        PriceClass: PriceClass_{{priceClass}}
        ViewerCertificate:
          AcmCertificateArn: {{certificate}}
          SslSupportMethod: "sni-only"
          MinimumProtocolVersion: {{protocolVersion}}
  {{/each}}

  DNS:
    Type: AWS::Route53::RecordSetGroup
    DependsOn:
      {{#each cloudfront}}
      - CloudFront{{@index}}
      {{/each}}
    Properties:
      Comment: Media endpoint
      HostedZoneId: {{route53.hostedZoneID}}
      RecordSets:
        {{#each route53.record}}
        - Name: {{name}}
          Type: A
          AliasTarget:
            DNSName: !GetAtt [ CloudFront{{@index}}, DomainName ]
            EvaluateTargetHealth: false
            HostedZoneId: Z2FDTNDATAQYW2
        {{/each}}
